<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Shared-Key Vault</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts: Outfit (Modern, Tech-focused) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Animate.css for entrance animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

</head>

<body class="d-flex flex-column min-vh-100 {% block body_class %}{% endblock %}">
    <div class="animated-bg"></div>
    <div id="particles-js" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay"
        class="d-none position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center"
        style="background: rgba(15, 23, 42, 0.9); z-index: 9999; backdrop-filter: blur(5px);">
        <div class="text-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
            <h4 class="mt-3 text-white fw-bold animate__animated animate__pulse animate__infinite">Processing Secure
                Data...</h4>
            <p class="text-white-50 small">Please wait while we perform cryptographic operations.</p>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="{{ url_for('main.index') }}">
                <i class="fas fa-shield-alt me-2"></i>SecureVault
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto gap-2">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.generate_key') }}">
                            <i class="fas fa-plus me-1"></i>Generate
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.encrypt_file') }}">
                            <i class="fas fa-lock me-1"></i>Encrypt
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.reconstruct_key') }}">
                            <i class="fas fa-puzzle-piece me-1"></i>Reconstruct
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.decrypt_file') }}">
                            <i class="fas fa-unlock me-1"></i>Decrypt
                        </a>
                    </li>

                    <!-- Session Timer (Only visible when active) -->
                    {% if session.get('session_expiry') %}
                    <li class="nav-item ms-lg-2 d-flex align-items-center">
                        <div id="session-countdown"
                            class="badge bg-danger bg-opacity-75 text-white p-2 border border-danger shadow-sm animate__animated animate__pulse animate__infinite"
                            data-expiry="{{ session.get('session_expiry') }}" title="Time remaining to decrypt files">
                            <i class="fas fa-hourglass-half me-1"></i> <span id="timer-text">--:--</span>
                        </div>
                    </li>
                    {% endif %}

                    <li class="nav-item ms-lg-2">
                        <a class="nav-link btn btn-outline-light btn-sm px-3 text-white"
                            href="{{ url_for('main.logs') }}">
                            <i class="fas fa-list-ul me-1"></i>Audit Logs
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-5 flex-grow-1">
        <!-- SweetAlert2 Message Handling -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                });

                {% for category, message in messages %}
                // Map Flask categories to SweetAlert types
                var type = '{{ category }}';
                if (type === 'danger') type = 'error';
                if (type === 'message') type = 'info';

                Toast.fire({
                    icon: type,
                    title: '{{ message }}'
                });
                {% endfor %}
            });
        </script>
        {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <footer class="bg-light py-4 mt-5 border-top text-center text-muted">
        <div class="container">
            <small>&copy; 2025 Secure Shared-Key System. Built with <i class="fas fa-heart text-danger"></i> and
                Python.</small>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Particles.js -->
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Initialize Particles
        particlesJS("particles-js", {
            "particles": {
                "number": { "value": 80, "density": { "enable": true, "value_area": 800 } },
                "color": { "value": "#ffffff" },
                "shape": { "type": "circle" },
                "opacity": { "value": 0.2, "random": false },
                "size": { "value": 3, "random": true },
                "line_linked": { "enable": true, "distance": 150, "color": "#ffffff", "opacity": 0.1, "width": 1 },
                "move": { "enable": true, "speed": 2, "direction": "none", "random": false, "straight": false, "out_mode": "out" }
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": { "onhover": { "enable": true, "mode": "grab" }, "onclick": { "enable": true, "mode": "push" } },
                "modes": { "grab": { "distance": 140, "line_linked": { "opacity": 1 } } }
            },
            "retina_detect": true
        });

        // Global Loading Overlay
        document.addEventListener('submit', function (e) {
            const form = e.target;
            if (form.closest('form')) {
                // Show overlay
                const overlay = document.getElementById('loading-overlay');
                overlay.classList.remove('d-none');
            }
        });

        // Session Countdown Logic
        document.addEventListener('DOMContentLoaded', function () {
            const timerEl = document.getElementById('session-countdown');
            if (timerEl) {
                const expiryTimestamp = parseFloat(timerEl.getAttribute('data-expiry'));
                const textEl = document.getElementById('timer-text');

                function updateTimer() {
                    const now = Date.now() / 1000;
                    const remaining = expiryTimestamp - now;

                    if (remaining <= 0) {
                        textEl.textContent = "Expired";
                        timerEl.classList.remove('bg-danger', 'animate__pulse');
                        timerEl.classList.add('bg-secondary');

                        // Optional: Redirect if on decrypt page
                        if (!window.expiryAlertShown) {
                            window.expiryAlertShown = true;
                            Swal.fire({
                                icon: 'warning',
                                title: 'Session Expired',
                                text: 'Your secure session has ended. Please reconstruct the key again.',
                                confirmButtonText: 'Reconstruct',
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    window.location.href = "{{ url_for('main.reconstruct_key') }}";
                                }
                            });
                        }
                    } else {
                        const m = Math.floor(remaining / 60);
                        const s = Math.floor(remaining % 60);
                        textEl.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                    }
                }

                updateTimer();
                setInterval(updateTimer, 1000);
            }

            // --- CINEMATIC AUDIO ENGINE ---
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            const SFX = {
                hover: () => {
                    if (audioCtx.state === 'suspended') audioCtx.resume();
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.05);
                    gain.gain.setValueAtTime(0.02, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);

                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.05);
                },
                click: () => {
                    if (audioCtx.state === 'suspended') audioCtx.resume();
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);

                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.1);
                }
            };

            // Attach Global Listeners
            document.body.addEventListener('mouseenter', (e) => {
                if (e.target.matches('a, button, .btn, .nav-link, .drop-zone')) {
                    SFX.hover();
                }
            }, true);

            document.body.addEventListener('mousedown', (e) => {
                if (e.target.matches('a, button, .btn, .nav-link, .drop-zone')) {
                    SFX.click();
                }
            }, true);
        });
    </script>
</body>

</html>